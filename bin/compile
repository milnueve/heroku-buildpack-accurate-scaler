#!/bin/sh

PUSHPROX_VERSION=0.1.0

BUILD_DIR=$1
CACHE_DIR=$2
#ENV_DIR=$3

arrow() {
  echo '----->' "$@"
}

fetch_pushprox() {
  if [ ! -f $CACHE_DIR/pushprox-client-${PUSHPROX_VERSION} ]; then
    arrow "Installing PushProx client v${PUSHPROX_VERSION} ..."
    wget --quiet -O pushprox.tar.gz https://github.com/prometheus-community/PushProx/releases/download/v${PUSHPROX_VERSION}/PushProx-${PUSHPROX_VERSION}.linux-amd64.tar.gz
    tar -xzf pushprox.tar.gz

    rm -f $CACHE_DIR/pushprox-* || true
    mv PushProx-${PUSHPROX_VERSION}.linux-amd64/pushprox-client $CACHE_DIR/pushprox-client-${PUSHPROX_VERSION}
  else
    arrow "PushProx Client v${PUSHPROX_VERSION} found in cache"
  fi
}

install_pushprox_client() {
  cp $CACHE_DIR/pushprox-client-${PUSHPROX_VERSION} $BUILD_DIR/bin/pushprox-client
  chmod a+x $BUILD_DIR/bin/pushprox-client
}

mkdir -p "$BUILD_DIR/bin"

fetch_pushprox
install_pushprox_client

mkdir -p $BUILD_DIR/.profile.d

if [ ! -f $BUILD_DIR/.profile.d/accurate-scaler.sh ]; then
  arrow "Installing startup script ..."
  cat > $BUILD_DIR/.profile.d/accurate-scaler.sh <<-SH
#!/bin/bash

export PATH=\$PATH:\$HOME/bin

# Check if buildpack was correctly installed or exit with failure
if [[ ! -x \$HOME/bin/pushprox-client ]]; then
  echo "PushProx Client not found. Buildpack failed to install correctly."
  exit 1
fi

monitored_proctypes=\${ACCURATE_SCALER_MONITORED_PROCTYPES:-web worker}

function proctype() {
  for monitored_proctype in \$monitored_proctypes; do
    if [[ \$DYNO =~ ^\$monitored_proctype.* ]]; then
      echo \$monitored_proctype
    fi
  done
}

dyno_proctype=\$(proctype)

# Check if dyno is running a monitored process type or notify and exit without failing
if [[ \$dyno_proctype == "" ]]; then
  echo "AccurateScaler: Dyno '\$DYNO' is not running a monitored process type, PushProx Client won't be started."
  exit 0
fi

echo "AccurateScaler: Detected monitored '\$dyno_proctype' process type running in dyno."

# Check if add-on is (correctly) installed or notify and exit without failing
if [[ \$ACCURATE_SCALER_PROXY_URL == "" || \$ACCURATE_SCALER_APP_ID == "" ]]; then
  echo "AccurateScaler: Add-on config vars missing! PushProx Client won't be started."
else
  echo "AccurateScaler: Starting PushProx client ..."
  pushprox-client --proxy-url="\$ACCURATE_SCALER_PROXY_URL" --fqdn "\${ACCURATE_SCALER_APP_ID}@\$(domainname -A):9394" &
fi
SH
fi
